<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DND 跑团管理平台 (纯前端模拟数据版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        [v-cloak] { display: none; }
        .code-editor {
            background-color: #1E1E1E;
            color: #D4D4D4;
            font-family: 'Courier New', Courier, monospace;
            border-radius: 0.5rem;
            padding: 1rem;
            font-size: 0.875rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" v-cloak class="min-h-screen" @click="handleAppClick">
        <!-- 模拟数据模式提示 -->
        <div class="fixed top-0 left-0 right-0 bg-yellow-400 text-yellow-900 text-center p-2 text-sm z-50">
            注意: 当前为纯前端模拟数据模式。所有更改将在刷新页面后重置。
        </div>

        <!-- 全局消息提示 -->
        <div v-if="globalMessage" :class="globalMessage.type === 'success' ? 'bg-green-500' : 'bg-red-500'" class="fixed top-10 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-white text-center z-40 transition-all duration-300">
            {{ globalMessage.text }}
        </div>
        
        <!-- 登录/注册界面 -->
        <div id="auth-view" v-if="!user.loggedIn" class="flex items-center justify-center min-h-screen pt-10">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-center">DND 跑团平台</h2>
                <div class="flex border-b">
                    <button @click="authMode = 'login'" :class="{ 'border-indigo-500 text-indigo-600': authMode === 'login' }" class="flex-1 py-2 font-semibold text-gray-500 border-b-2 focus:outline-none">登录</button>
                    <button @click="authMode = 'register'" :class="{ 'border-indigo-500 text-indigo-600': authMode === 'register' }" class="flex-1 py-2 font-semibold text-gray-500 border-b-2 focus:outline-none">注册</button>
                </div>
                <!-- 登录表单 -->
                <div v-if="authMode === 'login'" class="space-y-4">
                    <input v-model="credentials.email" @keyup.enter="login" type="email" placeholder="邮箱" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input v-model="credentials.password" @keyup.enter="login" type="password" placeholder="密码" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button @click="login" class="w-full px-4 py-2 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700">登录</button>
                    <div class="pt-4 border-t">
                        <p class="text-center text-sm text-gray-500 mb-2">或一键测试登录</p>
                        <div class="grid grid-cols-3 gap-2">
                            <button @click="quickLogin('admin')" class="w-full px-2 py-2 text-sm font-semibold text-white bg-red-500 rounded-md hover:bg-red-600">Admin</button>
                            <button @click="quickLogin('dm')" class="w-full px-2 py-2 text-sm font-semibold text-white bg-green-500 rounded-md hover:bg-green-600">DM</button>
                            <button @click="quickLogin('player')" class="w-full px-2 py-2 text-sm font-semibold text-white bg-blue-500 rounded-md hover:bg-blue-600">Player</button>
                        </div>
                    </div>
                </div>
                <!-- 注册表单 -->
                <div v-if="authMode === 'register'" class="space-y-4">
                    <input v-model="credentials.email" @keyup.enter="register" type="email" placeholder="邮箱" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input v-model="credentials.password" @keyup.enter="register" type="password" placeholder="密码" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button @click="register" class="w-full px-4 py-2 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700">注册</button>
                </div>
                 <p v-if="authError" class="text-red-500 text-sm text-center">{{ authError }}</p>
            </div>
        </div>

        <!-- 主应用界面 -->
        <div id="main-view" v-if="user.loggedIn" class="p-4 md:p-8 pt-16">
            <header class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <div>
                    <h1 class="text-3xl font-bold">DND 平台</h1>
                    <p class="text-gray-500">欢迎, {{ user.email }}! 你的用户ID: <code class="bg-gray-200 px-1 rounded">{{ user.uid }}</code></p>
                    <p class="text-gray-500">你的角色: <span v-for="role in user.roles" :key="role" class="inline-block bg-indigo-100 text-indigo-800 text-sm font-medium mr-2 px-2.5 py-0.5 rounded">{{ role.toUpperCase() }}</span></p>
                </div>
                <button @click="logout" class="px-4 py-2 font-semibold text-white bg-red-500 rounded-md hover:bg-red-600">退出</button>
            </header>

            <!-- 主导航标签 -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex space-x-4 -mb-px">
                    <button v-if="hasPermission('view_admin_panel')" @click.stop="activeTab = 'admin'" :class="{ 'active': activeTab === 'admin' }" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">后台管理</button>
                    <div v-if="hasPermission('create_entries')" class="relative" @click.stop>
                         <button @click="toggleDmMenu" :class="{ 'active': activeTab.startsWith('dm-') }" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">DM 工作台</button>
                        <div v-if="dm.dmMenuVisible" class="absolute top-full left-0 mt-1 bg-white rounded-md shadow-lg py-1 z-20">
                            <a href="#" @click.prevent="activeTab = 'dm-entries'; dm.dmMenuVisible = false" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">内容管理</a>
                            <a href="#" @click.prevent="activeTab = 'dm-template'; dm.dmMenuVisible = false" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">角色卡模板</a>
                            <a href="#" @click.prevent="activeTab = 'dm-party'; dm.dmMenuVisible = false" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">队伍管理</a>
                        </div>
                    </div>
                    <button v-if="hasPermission('edit_own_char_sheet')" @click.stop="activeTab = 'player'; setupDataViews()" :class="{ 'active': activeTab === 'player' }" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">玩家面板</button>
                </nav>
            </div>

            <!-- 内容区域 -->
            <div class="space-y-8">
                <!-- 管理员面板 -->
                <div v-if="activeTab === 'admin'">
                    <h2 class="text-2xl font-semibold mb-4">后台管理</h2>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="p-6 bg-white rounded-lg shadow">
                            <h3 class="font-semibold text-lg mb-4">用户管理</h3>
                            <div class="space-y-3 max-h-96 overflow-y-auto">
                                <div v-for="u in admin.users" :key="u.uid" class="p-3 border rounded-md flex flex-wrap justify-between items-center gap-2">
                                    <div>
                                        <p class="font-medium">{{ u.email }}</p>
                                        <p class="text-xs text-gray-500">{{ u.uid }}</p>
                                    </div>
                                    <div class="flex flex-col items-start">
                                        <label v-for="role in admin.roles" :key="role.name" class="flex items-center text-sm font-medium">
                                            <input type="checkbox" :value="role.name" :checked="u.roles && u.roles.includes(role.name)" @change="toggleUserRole(u, role.name, $event.target.checked)" class="mr-2 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                            {{ role.name }}
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 bg-white rounded-lg shadow">
                             <h3 class="font-semibold text-lg mb-4">角色与权限</h3>
                            <div class="space-y-4">
                                <div v-for="role in admin.roles" :key="role.id" class="p-3 border rounded-md">
                                    <h4 class="font-bold">{{ role.name.toUpperCase() }}</h4>
                                    <div class="mt-2 space-y-1">
                                        <label v-for="perm in admin.permissions" :key="perm.id" class="flex items-center text-sm">
                                            <input type="checkbox" :checked="role.permissions.includes(perm.id)" @change="updateRolePermission(role.id, perm.id, $event.target.checked)" class="mr-2 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                            {{ perm.description }}
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DM 内容管理面板 -->
                <div v-if="activeTab === 'dm-entries'">
                     <h2 class="text-2xl font-semibold mb-4">内容管理</h2>
                     <div class="grid md:grid-cols-3 gap-8">
                         <div class="md:col-span-2 p-6 bg-white rounded-lg shadow">
                            <h3 class="font-semibold text-lg mb-4">我的条目库</h3>
                             <button @click="createNewEntry" class="mb-4 w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">创建新条目</button>
                             <div class="space-y-3 max-h-96 overflow-y-auto">
                                <div v-for="entry in dm.entries" :key="entry.id" class="p-3 border rounded-md">
                                     <div class="flex justify-between items-start">
                                         <div>
                                            <p class="font-medium">{{ entry.title }} <span class="text-xs bg-gray-200 px-1 rounded">{{entry.type}}</span></p>
                                            <p class="text-xs text-gray-500">ID: {{ entry.id }}</p>
                                         </div>
                                         <div>
                                             <button @click="editEntry(entry)" class="text-sm text-blue-500 hover:underline mr-2">编辑</button>
                                             <button @click="deleteEntry(entry.id)" class="text-sm text-red-500 hover:underline">删除</button>
                                         </div>
                                     </div>
                                     <div v-if="entry.tags && entry.tags.length" class="mt-2 flex flex-wrap gap-1">
                                        <span v-for="tag in entry.tags" :key="tag" class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-0.5 rounded-full">{{ tag }}</span>
                                     </div>
                                </div>
                             </div>
                             <div class="mt-6 border-t pt-4">
                                 <h4 class="font-semibold text-md mb-2">打包条目生成访问码</h4>
                                 <div class="space-y-2">
                                     <p>选择要分享的条目:</p>
                                     <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-48 overflow-y-auto">
                                         <label v-for="entry in dm.entries" :key="entry.id" class="flex items-center text-sm p-2 border rounded-md">
                                             <input type="checkbox" :value="entry.id" v-model="dm.selectedEntries" class="mr-2 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                             {{ entry.title }}
                                         </label>
                                     </div>
                                     <button @click="generateAccessCode" :disabled="dm.selectedEntries.length === 0" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 disabled:bg-gray-400">生成访问码</button>
                                     <div v-if="dm.lastGeneratedCode" class="mt-2 p-3 bg-green-100 text-green-800 rounded-md text-center">
                                         <p>生成成功！访问码: <strong class="text-lg">{{ dm.lastGeneratedCode }}</strong> (请分享给玩家)</p>
                                     </div>
                                 </div>
                             </div>
                         </div>
                         <div v-if="dm.isEditing" class="p-6 bg-white rounded-lg shadow" @click.stop>
                             <h3 class="font-semibold text-lg mb-4">{{ dm.currentEntry.id ? '编辑条目' : '创建新条目' }}</h3>
                             <div class="space-y-4">
                                <input v-model="dm.currentEntry.title" placeholder="标题" class="w-full px-3 py-2 border rounded-md">
                                <div class="relative">
                                    <label for="entry-type" class="text-sm text-gray-600">分类</label>
                                    <input id="entry-type" v-model="dm.currentEntry.type" @click="toggleCategoryDropdown" placeholder="选择或输入新分类" autocomplete="off" class="w-full px-3 py-2 border rounded-md bg-white">
                                    <ul v-if="dm.categoryDropdownVisible" class="absolute z-10 w-full bg-white border rounded-md mt-1 max-h-40 overflow-y-auto shadow-lg">
                                        <li v-for="category in dm.presetCategories" :key="category" @mousedown.prevent="selectCategory(category)" class="px-3 py-2 cursor-pointer hover:bg-gray-100">{{ category }}</li>
                                    </ul>
                                </div>
                                <div>
                                    <label for="entry-tags" class="text-sm text-gray-600">标签 (输入后按回车添加)</label>
                                    <div class="flex flex-wrap items-center gap-2 p-2 border rounded-md bg-white">
                                        <span v-for="(tag, index) in dm.currentEntry.tags" :key="tag" class="flex items-center bg-blue-100 text-blue-800 text-sm font-medium px-2 py-1 rounded-full">
                                            {{ tag }}
                                            <button @click="removeTag(index)" class="ml-1.5 text-blue-600 hover:text-blue-800"><svg class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
                                        </span>
                                        <input id="entry-tags" v-model="dm.newTag" @keydown.enter.prevent="addTag" placeholder="新标签..." class="flex-1 min-w-[80px] border-none focus:ring-0 p-1">
                                    </div>
                                </div>
                                <div v-if="dm.currentEntry.type === '物品'" class="border-t pt-4">
                                    <h4 class="font-medium mb-2">技能修正</h4>
                                    <div v-for="(mod, index) in dm.currentEntry.modifications" :key="index" class="p-3 border rounded-md bg-gray-50 space-y-2">
                                        <div class="relative">
                                             <label class="text-xs text-gray-500">要修正的技能名</label>
                                            <div class="relative">
                                                <input v-model="mod.targetSkillName" @click="toggleModificationDropdown(index)" placeholder="选择一个技能..." autocomplete="off" readonly class="w-full pl-3 pr-10 py-2 border rounded-md bg-white text-sm cursor-pointer">
                                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                                </div>
                                            </div>
                                            <ul v-if="dm.activeModificationDropdown === index" class="absolute z-20 w-full bg-white border rounded-md mt-1 max-h-40 overflow-y-auto shadow-lg">
                                                <li v-for="skill in availableSkills" :key="skill" @click="selectModificationSkill(mod, skill)" class="px-3 py-2 cursor-pointer hover:bg-gray-100 text-sm">
                                                    {{ skill }}
                                                </li>
                                            </ul>
                                        </div>
                                        <textarea v-model="mod.newDescription" placeholder="修正后的新效果描述" rows="2" class="w-full px-2 py-1 border rounded-md text-sm"></textarea>
                                        <input v-model.number="mod.priority" type="number" placeholder="优先级 (数字大优先)" class="w-full px-2 py-1 border rounded-md text-sm">
                                        <button @click="removeModification(index)" class="w-full text-xs bg-red-100 hover:bg-red-200 text-red-700 py-1 rounded-md">移除此修正</button>
                                    </div>
                                    <button @click="addModification" class="w-full text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-md mt-2">添加技能修正</button>
                                </div>
                                <p class="text-sm text-gray-500">内容 (支持 Markdown):</p>
                                <textarea v-model="dm.currentEntry.content" rows="10" placeholder="详细内容..." class="w-full px-3 py-2 border rounded-md"></textarea>
                                 <div class="flex space-x-2">
                                     <button @click="saveEntry" class="flex-1 bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">保存</button>
                                     <button @click="dm.isEditing = false" class="flex-1 bg-gray-300 py-2 rounded-md hover:bg-gray-400">取消</button>
                                 </div>
                             </div>
                         </div>
                     </div>
                </div>
                
                <!-- DM 角色卡模板编辑器 -->
                <div v-if="activeTab === 'dm-template'">
                    <h2 class="text-2xl font-semibold mb-4">角色卡模板编辑器</h2>
                    <div class="p-6 bg-white rounded-lg shadow space-y-6" @click.stop>
                        <div v-for="(module, modIndex) in dm.charSheetTemplate.modules" :key="module.id" class="p-4 border rounded-lg bg-gray-50">
                            <div class="flex justify-between items-center mb-4">
                                <input class="font-semibold text-lg border-b-2 border-transparent focus:border-indigo-500 outline-none bg-transparent" v-model="module.title" @blur="saveTemplate">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded-full">{{ getModuleTypeName(module.type) }}</span>
                                    <button @click="removeModuleFromTemplate(modIndex)" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100">
                                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                            </div>
                            <div v-if="module.type === 'key-value-list'" class="space-y-2">
                                <p class="text-sm text-gray-600">预设属性栏位:</p>
                                <div v-for="(key, keyIndex) in module.keys" :key="keyIndex" class="flex items-center">
                                    <input v-model="module.keys[keyIndex]" @blur="saveTemplate" class="w-full px-3 py-1 border rounded-md text-sm">
                                    <button @click="removeKeyFromTemplate(module, keyIndex)" class="ml-2 text-gray-400 hover:text-red-500">
                                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                    </button>
                                </div>
                                <button @click="addKeyToTemplate(module)" class="w-full text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 rounded-md mt-2">添加栏位</button>
                            </div>
                            <div v-if="module.type === 'skill-selection-list'" class="space-y-2">
                                <p class="text-sm text-gray-600">预设技能池:</p>
                                <div v-for="(skill, skillIndex) in module.availableSkills" :key="skillIndex" class="flex items-center">
                                    <input v-model="module.availableSkills[skillIndex]" @blur="saveTemplate" class="w-full px-3 py-1 border rounded-md text-sm">
                                    <button @click="removeSkillFromTemplate(module, skillIndex)" class="ml-2 text-gray-400 hover:text-red-500">
                                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                    </button>
                                </div>
                                <button @click="addSkillToTemplate(module)" class="w-full text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 rounded-md mt-2">添加技能</button>
                            </div>
                            <div v-if="module.type === 'computed-field'" class="space-y-2">
                                <p class="text-sm text-gray-600">计算逻辑 (JavaScript):</p>
                                <textarea v-model="module.formula" @blur="saveTemplate" rows="4" class="w-full code-editor"></textarea>
                                <div class="text-xs text-gray-500 bg-gray-200 p-2 rounded-md">
                                    <p>提示: 你可以使用 `sheet` 对象访问角色卡数据。例如:</p>
                                    <pre class="mt-1"><code>// 获取“属性”模块的数据
const statsModule = sheet.modules.find(m => m.title === '属性');
// 获取“力量”属性值 (转为数字)
const str = parseInt(statsModule.data['力量']) || 0;
// 返回计算结果 (例如: 力量调整值)
return Math.floor((str - 10) / 2);</code></pre>
                                </div>
                            </div>
                        </div>
                        <div class="relative">
                            <button @click="toggleAddModuleDropdown" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-md">添加新模块</button>
                            <div v-if="dm.addModuleDropdownVisible" class="absolute z-10 w-full bg-white border rounded-md mt-1 shadow-lg">
                                <a v-for="template in dm.moduleTemplates" :key="template.type" @click.prevent="addModuleToTemplate(template)" href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-500 hover:text-white">{{ template.name }}</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DM 队伍管理面板 -->
                <div v-if="activeTab === 'dm-party'">
                    <h2 class="text-2xl font-semibold mb-4">队伍管理</h2>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="md:col-span-1 p-6 bg-white rounded-lg shadow">
                             <h3 class="font-semibold text-lg mb-4">玩家列表</h3>
                             <div class="space-y-2">
                                <button v-for="player in partyMembers" :key="player.uid" @click="selectManagedPlayer(player)"
                                    class="w-full text-left p-3 rounded-md border"
                                    :class="{'bg-indigo-100 border-indigo-400': dm.managedPlayerId === player.uid, 'hover:bg-gray-50': dm.managedPlayerId !== player.uid}">
                                    {{ player.email }}
                                </button>
                             </div>
                        </div>
                        <div v-if="managedPlayerSheet" class="md:col-span-2 p-6 bg-white rounded-lg shadow" @click.stop>
                            <h3 class="font-semibold text-lg mb-4">正在编辑 {{ managedPlayer.email }} 的角色卡</h3>
                            <div class="space-y-6">
                                <div v-for="module in managedPlayerSheet.modules" :key="module.id">
                                    <div v-if="module.type === 'basic-info'" class="border-b pb-6 mb-6">
                                        <h3 class="font-semibold text-lg mb-4">{{ module.title }}</h3>
                                        <div class="space-y-4">
                                            <input v-model="module.data.name" @blur="saveManagedPlayerSheet" placeholder="角色名" class="w-full px-3 py-2 border rounded-md">
                                            <input v-model="module.data.raceClass" @blur="saveManagedPlayerSheet" placeholder="种族与职业" class="w-full px-3 py-2 border rounded-md">
                                        </div>
                                    </div>
                                    <div v-if="module.type === 'key-value-list'" class="border-b pb-6 mb-6">
                                        <h3 class="font-semibold text-lg mb-4">{{ module.title }}</h3>
                                        <div class="space-y-2">
                                            <div v-for="key in findTemplateModule(module).keys" :key="key" class="grid grid-cols-3 items-center gap-2">
                                                <label class="font-medium text-sm text-gray-700 col-span-1">{{ key }}</label>
                                                <input v-model="module.data[key]" @blur="saveManagedPlayerSheet" placeholder="-" class="col-span-2 px-3 py-2 border rounded-md">
                                            </div>
                                        </div>
                                    </div>
                                    <div v-if="module.type === 'skill-selection-list'" class="border-b pb-6 mb-6">
                                        <h3 class="font-semibold text-lg mb-4">{{ module.title }}</h3>
                                        <div class="space-y-2">
                                            <label v-for="skillName in findTemplateModule(module).availableSkills" :key="skillName" class="flex items-center p-2 rounded-md hover:bg-gray-50">
                                                <input type="checkbox" v-model="module.data[skillName]" @change="saveManagedPlayerSheet" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                                <span class="ml-3 font-medium text-sm text-gray-800">{{ skillName }}</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div v-if="module.type === 'item-list'" class="border-b pb-6 mb-6">
                                        <h3 class="font-semibold text-lg mb-4">{{ module.title }}</h3>
                                        <div class="space-y-3">
                                            <div v-for="(item, index) in module.data" :key="item.id" class="p-3 border rounded-md space-y-2">
                                                <div class="flex items-center space-x-2">
                                                    <span class="flex-1 font-medium">{{ item.name }}</span>
                                                    <input v-model.number="item.quantity" @blur="saveManagedPlayerSheet" type="number" placeholder="数量" class="w-20 px-3 py-2 border rounded-md">
                                                    <button @click="removeItemFromManaged(module, index)" class="text-red-500 hover:text-red-700 p-2 rounded-full bg-red-100 hover:bg-red-200">
                                                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                                    </button>
                                                </div>
                                                <textarea v-model="item.notes" @blur="saveManagedPlayerSheet" placeholder="备注或描述" rows="1" class="w-full text-sm px-3 py-1 border rounded-md"></textarea>
                                            </div>
                                        </div>
                                        <div class="relative">
                                            <button @click="toggleAddItemDropdown" class="w-full text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-md">给玩家添加物品</button>
                                            <ul v-if="dm.addItemDropdownVisible" class="absolute bottom-full mb-2 z-20 w-full bg-white border rounded-md mt-1 max-h-48 overflow-y-auto shadow-lg">
                                                <li v-for="entry in availableItems" :key="entry.id" @click="addItemToManaged(module, entry.title)" class="px-3 py-2 cursor-pointer hover:bg-gray-100">
                                                    {{ entry.title }}
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div v-if="module.type === 'long-text'" class="border-b pb-6 mb-6">
                                        <h3 class="font-semibold text-lg mb-4">{{ module.title }}</h3>
                                        <textarea v-model="module.data.text" @blur="saveManagedPlayerSheet" rows="8" placeholder="..." class="w-full px-3 py-2 border rounded-md"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <div v-else class="md:col-span-2 flex items-center justify-center p-6 bg-white rounded-lg shadow">
                            <p class="text-gray-500">请从左侧选择一个玩家进行编辑。</p>
                        </div>
                    </div>
                </div>


                <!-- 玩家面板 -->
                <div v-if="activeTab === 'player'">
                    <h2 class="text-2xl font-semibold mb-4">玩家面板</h2>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="p-6 bg-white rounded-lg shadow space-y-6">
                            <div v-for="module in player.charSheet.modules" :key="module.id" @click.stop>
                                <div v-if="module.type === 'basic-info'" class="border-b pb-6 mb-6">
                                    <h3 class="font-semibold text-lg mb-4">{{ module.title }}</h3>
                                    <div class="space-y-2">
                                        <p><span class="font-medium text-gray-600">角色名: </span>{{ module.data.name || '-' }}</p>
                                        <p><span class="font-medium text-gray-600">种族与职业: </span>{{ module.data.raceClass || '-' }}</p>
                                    </div>
                                </div>
                                <div v-if="module.type === 'key-value-list'" class="border-b pb-6 mb-6">
                                    <h3 class="font-semibold text-lg mb-4">{{ module.title }}</h3>
                                    <div class="space-y-2">
                                        <div v-for="key in findTemplateModule(module).keys" :key="key" class="p-2 border-l-4 rounded" :class="getSkillModification(key) ? 'border-yellow-400 bg-yellow-50' : 'border-transparent'">
                                            <div class="flex justify-between items-center">
                                                <span class="font-medium text-sm text-gray-700">{{ key }}</span>
                                                <span class="font-bold text-gray-900">{{ module.data[key] || '-' }}</span>
                                            </div>
                                            <div v-if="getSkillModification(key)" class="mt-2 text-xs p-2 rounded-md bg-yellow-100 text-yellow-800">
                                                <p><span class="font-bold">{{ getSkillModification(key).sourceItem }}</span> 效果: {{ getSkillModification(key).description }}</p>
                                            </div>
                                        </div>
                                        <p v-if="!findTemplateModule(module).keys || findTemplateModule(module).keys.length === 0" class="text-sm text-gray-400 text-center">DM尚未设定此模块的栏位</p>
                                    </div>
                                </div>
                                <div v-if="module.type === 'skill-selection-list'" class="border-b pb-6 mb-6">
                                    <h3 class="font-semibold text-lg mb-4">{{ module.title }}</h3>
                                    <div class="space-y-2">
                                        <label v-for="skillName in findTemplateModule(module).availableSkills" :key="skillName" class="flex items-center p-2 rounded-md hover:bg-gray-50">
                                            <svg v-if="module.data[skillName]" class="w-5 h-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                            <svg v-else class="w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                                            <span class="ml-3 font-medium text-sm text-gray-800">{{ skillName }}</span>
                                        </label>
                                        <p v-if="!findTemplateModule(module).availableSkills || findTemplateModule(module).availableSkills.length === 0" class="text-sm text-gray-400 text-center">DM尚未设定此模块的技能</p>
                                    </div>
                                </div>
                                <div v-if="module.type === 'item-list'" class="border-b pb-6 mb-6">
                                    <h3 class="font-semibold text-lg mb-4">{{ module.title }}</h3>
                                    <div v-if="!module.data || module.data.length === 0" class="text-sm text-gray-500 text-center py-4">你的背包空空如也...</div>
                                    <div v-else class="space-y-3">
                                        <div v-for="(item, index) in module.data" :key="item.id" class="p-3 border rounded-md">
                                            <div class="flex justify-between items-center">
                                                <span class="font-medium">{{ item.name }}</span>
                                                <span class="font-bold text-lg">x {{ item.quantity }}</span>
                                            </div>
                                            <p v-if="item.notes" class="text-sm text-gray-600 mt-1">{{ item.notes }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="module.type === 'long-text'" class="border-b pb-6 mb-6">
                                    <h3 class="font-semibold text-lg mb-4">{{ module.title }}</h3>
                                    <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ module.data.text || '-' }}</p>
                                </div>
                                <div v-if="module.type === 'computed-field'" class="border-b pb-6 mb-6">
                                    <h3 class="font-semibold text-lg mb-4">{{ module.title }}</h3>
                                    <div class="p-3 bg-gray-100 rounded-md text-center">
                                        <p class="text-2xl font-bold text-indigo-600">{{ getComputedValue(module) }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-8">
                           <div class="p-6 bg-white rounded-lg shadow">
                               <h3 class="font-semibold text-lg mb-4">解锁内容</h3>
                               <div class="flex space-x-2">
                                   <input v-model="player.accessCodeInput" placeholder="输入DM给的访问码" class="flex-1 px-3 py-2 border rounded-md">
                                   <button @click="redeemAccessCode" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">解锁</button>
                               </div>
                           </div>
                            <div class="p-6 bg-white rounded-lg shadow">
                                <h3 class="font-semibold text-lg mb-4">已解锁条目</h3>
                                <div v-if="player.unlockedEntries.length === 0" class="text-gray-500">暂无内容</div>
                                <div class="space-y-4 max-h-screen overflow-y-auto">
                                    <div v-for="entry in player.unlockedEntries" :key="entry.id" class="p-4 border rounded-lg">
                                        <h4 class="text-xl font-bold">{{ entry.title }} <span class="text-sm bg-gray-200 px-1.5 py-0.5 rounded">{{entry.type}}</span></h4>
                                        <div class="prose max-w-none mt-2" v-html="renderMarkdown(entry.content)"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        // --- 模拟数据库 ---
        const mockDatabase = {
            permissions: [ { id: 'view_admin_panel', description: '查看后台管理面板' }, { id: 'manage_roles_permissions', description: '管理角色和权限' }, { id: 'manage_users', description: '管理用户角色' }, { id: 'create_entries', description: '创建和编辑条目' }, { id: 'generate_access_codes', description: '打包条目生成访问码' }, { id: 'edit_own_char_sheet', description: '编辑自己的角色卡' }, { id: 'view_shared_content', description: '查看被分享的内容' }, ],
            roles: [ { id: 'admin', name: 'admin', permissions: ['view_admin_panel', 'manage_roles_permissions', 'manage_users'] }, { id: 'dm', name: 'dm', permissions: ['create_entries', 'generate_access_codes', 'view_shared_content', 'edit_own_char_sheet'] }, { id: 'player', name: 'player', permissions: ['edit_own_char_sheet', 'view_shared_content'] } ],
            users: [ { uid: 'user-001', email: 'admin@test.com', password: 'password123', roles: ['admin'] }, { uid: 'user-002', email: 'dm@test.com', password: 'password123', roles: ['dm', 'player'] }, { uid: 'user-003', email: 'player@test.com', password: 'password123', roles: ['player'] } ],
            presetCategories: ['NPC', '地点', '任务', '物品', '背景', '组织', '历史', '技能'],
            entries: [ { id: 'entry-1', authorId: 'user-002', title: '临冬城', type: '地点', content: '北境的古老首都，史塔克家族的城堡。', tags: ['地点', '北境', '史塔克'] }, { id: 'entry-2', authorId: 'user-002', title: 'NPC: 铁匠巴隆', type: 'NPC', content: '一位脾气古怪但技艺高超的铁匠。', tags: ['NPC', '工匠'] }, { id: 'skill-fireball', authorId: 'user-002', title: '火焰箭', type: '技能', content: '造成1d6火焰伤害。', tags: ['法术', '塑能'] }, { id: 'item-firering', authorId: 'user-002', title: '炎之指环', type: '物品', content: '一枚刻有火焰符文的红宝石戒指。', tags: ['魔法物品', '戒指'], modifications: [{ targetSkillName: '火焰箭', newDescription: '伤害提升至2d6。', priority: 10 }] } ],
            characterSheetModuleTemplates: [ { type: 'basic-info', name: '基本信息', defaultData: { name: '', raceClass: '' } }, { type: 'key-value-list', name: '属性列表', defaultData: {} }, { type: 'item-list', name: '物品清单', defaultData: [] }, { type: 'long-text', name: '文本笔记', defaultData: { text: '' } }, { type: 'computed-field', name: '自动计算栏位', defaultData: { formula: 'return 0;' } }, { type: 'skill-selection-list', name: '技能选择列表', defaultData: {} } ],
            characterSheetTemplate: {
                modules: [
                    { id: 'mod-1', title: '基本信息', type: 'basic-info' },
                    { id: 'mod-2', title: '属性', type: 'key-value-list', keys: ['力量', '敏捷', '体质', '智力', '感知', '魅力'] },
                    { id: 'mod-5', title: '力量调整值', type: 'computed-field', formula: "const statsModule = sheet.modules.find(m => m.title === '属性');\nif (!statsModule || !statsModule.data) return 0;\nconst str = parseInt(statsModule.data['力量']) || 0;\nconst mod = Math.floor((str - 10) / 2);\nreturn mod > 0 ? '+' + mod : mod;" },
                    { id: 'mod-6', title: '技能熟练项', type: 'skill-selection-list', availableSkills: ['体操', '运动', '游说', '威吓', '隐匿', '察觉'] },
                    { id: 'mod-7', title: '法术与戏法', type: 'key-value-list', keys: ['火焰箭', '法师之手'] },
                    { id: 'mod-3', title: '物品与装备', type: 'item-list' },
                    { id: 'mod-4', title: '背景与笔记', type: 'long-text' }
                ]
            },
            character_sheets: {},
            shared_packages: []
        };
        
        const App = {
            data() {
                return { authMode: 'login', credentials: { email: '', password: '' }, authError: '', user: { loggedIn: false, uid: null, email: null, roles: [], permissions: new Set() }, globalMessage: null, activeTab: '', admin: {}, dm: {}, player: {}, db: {} }
            },
            
            computed: {
                availableSkills() {
                    let skills = [];
                    if (this.dm.charSheetTemplate && this.dm.charSheetTemplate.modules) {
                        this.dm.charSheetTemplate.modules.forEach(module => {
                            if (module.type === 'key-value-list' && module.keys) {
                                skills = skills.concat(module.keys);
                            } else if (module.type === 'skill-selection-list' && module.availableSkills) {
                                skills = skills.concat(module.availableSkills);
                            }
                        });
                    }
                    return [...new Set(skills)];
                },
                availableItems() {
                    return this.db.entries.filter(e => e.type === '物品');
                },
                partyMembers() {
                    return this.db.users.filter(u => u.roles.includes('player'));
                },
                managedPlayer() {
                    return this.db.users.find(u => u.uid === this.dm.managedPlayerId);
                },
                managedPlayerSheet() {
                    if (!this.dm.managedPlayerId) return null;
                    return this.db.character_sheets[this.dm.managedPlayerId];
                }
            },
            methods: {
                showGlobalMessage(text, type = 'success', duration = 3000) { this.globalMessage = { text, type }; setTimeout(() => { this.globalMessage = null; }, duration); },
                renderMarkdown(md) { if(!md) return ''; return new showdown.Converter().makeHtml(md); },
                generateId(prefix = 'id') { return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`; },
                login() { this.authError = ''; const foundUser = this.db.users.find(u => u.email === this.credentials.email && u.password === this.credentials.password); if (foundUser) { this.onLogin(foundUser); } else { this.authError = "邮箱或密码错误。"; } },
                quickLogin(role) { const emailMap = { admin: 'admin@test.com', dm: 'dm@test.com', player: 'player@test.com' }; const userToLogin = this.db.users.find(u => u.email === emailMap[role]); if (userToLogin) { this.onLogin(userToLogin); } },
                register() { this.authError = ''; if (this.db.users.find(u => u.email === this.credentials.email)) { this.authError = '该邮箱已被注册。'; return; } const newUser = { uid: this.generateId('user'), email: this.credentials.email, password: this.credentials.password, roles: ['player'] }; this.db.users.push(newUser); this.db.character_sheets[newUser.uid] = null; this.showGlobalMessage('注册成功！请登录。'); this.authMode = 'login'; },
                logout() { this.resetViews(); },
                hasPermission(perm) { return this.user.permissions.has(perm); },
                resetStateAndDb() { this.db = JSON.parse(JSON.stringify(mockDatabase)); this.resetViews(); },
                resetViews() { this.user = { loggedIn: false, uid: null, email: null, roles: [], permissions: new Set() }; this.activeTab = 'login'; this.admin = { users: this.db.users, roles: this.db.roles, permissions: this.db.permissions, }; this.dm = { entries: [], currentEntry: { id: null, title: '', content: '', type: 'NPC', tags: [], modifications: [] }, isEditing: false, selectedEntries: [], lastGeneratedCode: '', presetCategories: this.db.presetCategories, categoryDropdownVisible: false, newTag: '', charSheetTemplate: this.db.characterSheetTemplate, moduleTemplates: this.db.characterSheetModuleTemplates, addModuleDropdownVisible: false, dmMenuVisible: false, activeModificationDropdown: null, managedPlayerId: null, addItemDropdownVisible: false }; this.player = { charSheet: { modules: [] }, saveStatus: '', accessCodeInput: '', unlockedEntries: [], activeItemDropdown: null }; },
                onLogin(loginUser) { this.resetViews(); this.user.loggedIn = true; this.user.uid = loginUser.uid; this.user.email = loginUser.email; this.user.roles = loginUser.roles || []; this.loadPermissions(); this.setupDataViews(); this.setDefaultTab(); },
                setDefaultTab() { if (this.hasPermission('view_admin_panel')) { this.activeTab = 'admin'; } else if (this.hasPermission('create_entries')) { this.activeTab = 'dm-entries'; } else if (this.hasPermission('edit_own_char_sheet')) { this.activeTab = 'player'; } },
                loadPermissions() { this.user.permissions.clear(); if (this.user.roles.length === 0) return; const userRolesData = this.db.roles.filter(r => this.user.roles.includes(r.name)); userRolesData.forEach(roleData => { if (roleData.permissions) { roleData.permissions.forEach(perm => this.user.permissions.add(perm)); } }); },
                setupDataViews() { if (this.hasPermission('create_entries')) { this.dm.entries = this.db.entries.filter(e => e.authorId === this.user.uid); } if (this.hasPermission('edit_own_char_sheet')) { this.syncPlayerSheetWithTemplate(this.user.uid); } this.loadUnlockedContent(); },
                syncPlayerSheetWithTemplate(playerId) { let playerData = this.db.character_sheets[playerId]; const template = this.db.characterSheetTemplate; const syncedModules = template.modules.map(templateModule => { const playerModule = playerData?.modules.find(pMod => pMod.id === templateModule.id); let data = {}; if (playerModule) { data = playerModule.data; } else { const moduleTemplate = this.db.characterSheetModuleTemplates.find(t => t.type === templateModule.type); data = JSON.parse(JSON.stringify(moduleTemplate.defaultData)); } return { ...templateModule, data: data }; }); const finalSheet = { modules: syncedModules }; this.db.character_sheets[playerId] = finalSheet; if (this.user.uid === playerId) { this.player.charSheet = finalSheet; } return finalSheet; },
                loadUnlockedContent() { this.player.unlockedEntries = []; const unlockedPackages = this.db.shared_packages.filter(p => p.authorizedUsers.includes(this.user.uid)); const unlockedEntryIds = new Set(); unlockedPackages.forEach(p => { p.entryIds.forEach(id => unlockedEntryIds.add(id)); }); this.player.unlockedEntries = this.db.entries.filter(e => unlockedEntryIds.has(e.id)); },
                toggleUserRole(user, roleName, isChecked) { const targetUser = this.db.users.find(u => u.uid === user.uid); if (!targetUser) return; const roles = new Set(targetUser.roles || []); if (isChecked) { roles.add(roleName); } else { roles.delete(roleName); } targetUser.roles = Array.from(roles); this.showGlobalMessage("用户角色更新成功!"); },
                updateRolePermission(roleId, permId, checked) { const targetRole = this.db.roles.find(r => r.id === roleId); if (!targetRole) return; const permissions = new Set(targetRole.permissions || []); if(checked) { permissions.add(permId); } else { permissions.delete(permId); } targetRole.permissions = Array.from(permissions); this.showGlobalMessage("权限更新成功!"); this.loadPermissions(); },
                createNewEntry() { this.dm.currentEntry = { id: null, title: '', content: '', type: 'NPC', tags: [], modifications: [] }; this.dm.isEditing = true; },
                editEntry(entry) { this.dm.currentEntry = { tags:[], modifications: [], ...JSON.parse(JSON.stringify(entry)) }; this.dm.isEditing = true; },
                saveEntry() { if (!this.dm.currentEntry.title) { this.showGlobalMessage("标题不能为空", "error"); return; } if (this.dm.currentEntry.id) { const index = this.db.entries.findIndex(e => e.id === this.dm.currentEntry.id); if(index > -1) this.db.entries[index] = { ...this.dm.currentEntry }; } else { this.db.entries.push({ ...this.dm.currentEntry, id: this.generateId('entry'), authorId: this.user.uid }); } this.dm.isEditing = false; this.setupDataViews(); },
                deleteEntry(entryId) { if(window.confirm("确定要删除这个条目吗？")) { this.db.entries = this.db.entries.filter(e => e.id !== entryId); this.setupDataViews(); this.showGlobalMessage("条目已删除"); } },
                generateAccessCode() { const code = 'dnd-' + Math.random().toString(36).substr(2, 8); this.db.shared_packages.push({ id: this.generateId('pkg'), creatorId: this.user.uid, accessCode: code, entryIds: this.dm.selectedEntries, authorizedUsers: [] }); this.dm.lastGeneratedCode = code; this.dm.selectedEntries = []; },
                toggleCategoryDropdown() { this.dm.categoryDropdownVisible = !this.dm.categoryDropdownVisible; },
                selectCategory(category) { this.dm.currentEntry.type = category; this.dm.categoryDropdownVisible = false; },
                addTag() { const newTag = this.dm.newTag.trim(); if (newTag && !this.dm.currentEntry.tags.includes(newTag)) { this.dm.currentEntry.tags.push(newTag); } this.dm.newTag = ''; },
                removeTag(index) { this.dm.currentEntry.tags.splice(index, 1); },
                addModification() { if(!this.dm.currentEntry.modifications) { this.dm.currentEntry.modifications = []; } this.dm.currentEntry.modifications.push({targetSkillName: '', newDescription: '', priority: 0}); },
                removeModification(index) { this.dm.currentEntry.modifications.splice(index, 1); },
                toggleModificationDropdown(index) { if (this.dm.activeModificationDropdown === index) { this.dm.activeModificationDropdown = null; } else { this.dm.activeModificationDropdown = index; } },
                selectModificationSkill(mod, skill) { mod.targetSkillName = skill; this.dm.activeModificationDropdown = null; },
                getModuleTypeName(type) { const template = this.dm.moduleTemplates.find(t => t.type === type); return template ? template.name : '未知模块'; },
                saveTemplate() { this.db.characterSheetTemplate = JSON.parse(JSON.stringify(this.dm.charSheetTemplate)); this.showGlobalMessage("模板已保存!", "success");},
                toggleAddModuleDropdown() { this.dm.addModuleDropdownVisible = !this.dm.addModuleDropdownVisible; },
                addModuleToTemplate(template) { const newModule = { id: this.generateId('mod'), title: template.name, type: template.type, }; if (template.type === 'key-value-list') { newModule.keys = []; } else if(template.type === 'skill-selection-list') { newModule.availableSkills = []; } if (template.type === 'computed-field') { newModule.formula = 'return 0;'; } this.dm.charSheetTemplate.modules.push(newModule); this.dm.addModuleDropdownVisible = false; this.saveTemplate(); },
                removeModuleFromTemplate(index) { this.dm.charSheetTemplate.modules.splice(index, 1); this.saveTemplate(); },
                addKeyToTemplate(module) { if (!module.keys) { module.keys = []; } module.keys.push('新属性'); this.saveTemplate(); },
                removeKeyFromTemplate(module, keyIndex) { module.keys.splice(keyIndex, 1); this.saveTemplate(); },
                addSkillToTemplate(module) { if (!module.availableSkills) { module.availableSkills = []; } module.availableSkills.push('新技能'); this.saveTemplate(); },
                removeSkillFromTemplate(module, skillIndex) { module.availableSkills.splice(skillIndex, 1); this.saveTemplate(); },
                saveCharSheet() { this.db.character_sheets[this.user.uid] = JSON.parse(JSON.stringify(this.player.charSheet)); this.player.saveStatus = '已保存 ' + new Date().toLocaleTimeString(); setTimeout(() => this.player.saveStatus = '', 2000); },
                toggleItemDropdown(index) { this.player.activeItemDropdown = this.player.activeItemDropdown === index ? null : index; },
                selectItem(item, itemName) { item.name = itemName; this.player.activeItemDropdown = null; this.saveCharSheet(); },
                findTemplateModule(playerModule) { return this.db.characterSheetTemplate.modules.find(mod => mod.id === playerModule.id) || {}; },
                getComputedValue(module) { try { const formulaSrc = this.findTemplateModule(module).formula || 'return "NO FORMULA"'; const calculate = new Function('sheet', formulaSrc); return calculate(this.player.charSheet); } catch (e) { console.error("计算错误:", e); return "#错误!"; } },
                getSkillModification(skillName) {
                    const inventoryModule = this.player.charSheet.modules.find(m => m.type === 'item-list');
                    if (!inventoryModule || !inventoryModule.data) return null;

                    const equippedItems = inventoryModule.data.map(item => this.db.entries.find(e => e.title === item.name && e.type === '物品')).filter(Boolean);
                    
                    const modifications = [];
                    equippedItems.forEach(item => {
                        if (item.modifications) {
                            item.modifications.forEach(mod => {
                                if (mod.targetSkillName === skillName) {
                                    modifications.push({ ...mod, sourceItem: item.title });
                                }
                            });
                        }
                    });

                    if (modifications.length === 0) return null;
                    
                    modifications.sort((a, b) => b.priority - a.priority);
                    return { description: modifications[0].newDescription, sourceItem: modifications[0].sourceItem };
                },
                redeemAccessCode() { const code = this.player.accessCodeInput.trim(); if (!code) return; const pkg = this.db.shared_packages.find(p => p.accessCode === code); if (!pkg) { this.showGlobalMessage('无效的访问码', 'error'); return; } if (!pkg.authorizedUsers.includes(this.user.uid)) { pkg.authorizedUsers.push(this.user.uid); } this.showGlobalMessage('解锁成功!', 'success'); this.player.accessCodeInput = ''; this.loadUnlockedContent(); },
                handleAppClick() {
                    this.dm.categoryDropdownVisible = false;
                    this.dm.activeModificationDropdown = null;
                    this.dm.addModuleDropdownVisible = false;
                    this.player.activeItemDropdown = null;
                    this.dm.addItemDropdownVisible = false;
                    this.dm.dmMenuVisible = false;
                },
                toggleDmMenu() { this.dm.dmMenuVisible = !this.dm.dmMenuVisible; },
                selectManagedPlayer(player) {
                    this.syncPlayerSheetWithTemplate(player.uid);
                    this.dm.managedPlayerId = player.uid;
                },
                saveManagedPlayerSheet() {
                    if (!this.dm.managedPlayerId) return;
                    this.db.character_sheets[this.dm.managedPlayerId] = JSON.parse(JSON.stringify(this.managedPlayerSheet));
                    this.showGlobalMessage(`${this.managedPlayer.email} 的角色卡已更新!`, 'success');
                },
                toggleAddItemDropdown() { this.dm.addItemDropdownVisible = !this.dm.addItemDropdownVisible; },
                addItemToManaged(module, itemName) {
                    if (!module.data) { module.data = []; }
                    module.data.push({ id: this.generateId('item'), name: itemName, quantity: 1, notes: '' });
                    this.saveManagedPlayerSheet();
                    this.dm.addItemDropdownVisible = false;
                },
                removeItemFromManaged(module, index) {
                    module.data.splice(index, 1);
                    this.saveManagedPlayerSheet();
                },
            },
            mounted() {
                this.resetStateAndDb();
            }
        };

        Vue.createApp(App).mount('#app');
    </script>
</body>
</html>
